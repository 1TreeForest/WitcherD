FROM scratch
ADD squashfs-root /
RUN mkdir /tmp

# Install our own busybox
COPY busybox.armel /bin/busybox.tmp
RUN chmod 777 /bin/busybox.tmp
RUN mv /bin/busybox.tmp /bin/busybox

# Few manual fixes
RUN ln -s /bin/busybox /bin/chown

# /usr/bin/file
COPY file /usr/bin/file
RUN chmod 777 /usr/bin/file
RUN mkdir /lib/x86_64-linux-gnu/
RUN mkdir /lib64/

COPY libmagic.so.1 /lib/x86_64-linux-gnu/libmagic.so.1
COPY libc.so.6 /lib/x86_64-linux-gnu/libc.so.6
COPY libbz2.so.1.0 /lib/x86_64-linux-gnu/libbz2.so.1.0
COPY libz.so.1 /lib/x86_64-linux-gnu/libz.so.1
COPY ld-linux-x86-64.so.2 /lib64/ld-linux-x86-64.so.2
COPY magic.mgc /usr/share/misc/magic.mgc

COPY exploit.sh /exploit.sh

EXPOSE 80
ENV LD_PRELOAD="/lib/libnvram-faker.so"
CMD /bin/httpd
