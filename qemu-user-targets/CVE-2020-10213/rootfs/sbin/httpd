#!/firmadyne/sh
export STRICT=5
echo "STRICT=5" > /tmp/witcher.env
pkill -9 -f "/sbin/httpd.bin"        
trap 'pkill -9 -P $$;pkill -9 -f "/sbin/httpd.bin"' INT TERM KILL EXIT
args=$@
bin_name=$(basename "$(echo $'/sbin/httpd.bin'|cut -d " " -f1)")
printenv > /tmp/witcher_${bin_name}.log
echo "-- Starting /sbin/httpd.bin $args" >> /tmp/witcher_${bin_name}.log
/sbin/httpd.bin $args 2>&1 | /firmadyne/busybox tee -a /tmp/witcher_${bin_name}.log

ret=$?

pid=$(pgrep -f "/sbin/httpd.bin $args")
if [ -n "${pid}" ]; then
    /firmadyne/strace -p ${pid} -e 'trace=!all' > "/tmp/signal_${pid}.log" 2>&1
    if grep 'killed by SIG' /tmp/signal_${pid}.log; then
         /bin/echo "Received $(grep 'killed by' /tmp/signal_${pid}.log) from /sbin/httpd.bin, killing self"
         /bin/segme10 || /thisisasecret || true  # a hook that Wemu-system searches for to know that a segfault has occurred.
    fi 
elif [ $ret -eq 139 ]; then
    /bin/echo "Received 139 from /sbin/httpd.bin, killing self"
    /bin/segme10 || /thisisasecret || true  # a hook that Wemu-system searches for to know that a segfault has occurred.
fi 
