cp /rootfs/dev/mtdblock0 /dev/
cp /rootfs/dev/mtd0 /dev/

if ifconfig br0; then
    ip_addr=$(ifconfig br0 |egrep "inet [0-9\.]+" -oh|cut -d" " -f2)
elif ifconfig eth0; then
    echo "Attempting to find IP address using eth0"
    ip_addr=$(ifconfig eth0 |egrep "inet [0-9\.]+" -oh|cut -d" " -f2)
else
  echo "ERROR could not determine IP address to use"
  exit 99
fi
echo "IP address = $ip_addr"

brctl addbr br0
ifconfig br0 $ip_addr
brctl addif br0 eth0
ifconfig eth0 0.0.0.0 up

cp -r rootfs/lib/* /lib/
cp -r rootfs/bin/* /bin/
cp -r rootfs/web /web/
cp -r rootfs/web_mtn /web_mtn/

rm -f /bin/sh; ln -s /bin/dash /bin/sh

while /bin/true; do
    AFL_META_INFO_ID=80 STRICT=1 LD_PRELOAD=/wclibs/libcgiwrapper.bin /bin/goahead

   while (pgrep -f /bin/goahead > /dev/null) ; do
      sleep 1
   done

done
